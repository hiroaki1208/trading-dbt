version: 2

models:
  - name: dm_daily_aum
    description: "DM層。AUM(Asset Under Management)を日次で集計したテーブル"
    columns:
      - name: account
        description: "口座名(gp_fund,yuitomaru..)"
        tests:
          - not_null
      - name: ticker
        description: "ticker名"
        tests:
          - not_null
      - name: asset_type
        description: "アセット種別(株,金利..)"
        tests:
          - not_null
      - name: asset_name
        description: "アセット名"
        tests:
          - not_null
      - name: position
        description: "保有数量. cashは現金、その他は保有数量"
        tests:
          - not_null
          - dbt_utils.expression_is_true:
              expression: ">= 0"
      - name: value_price
        description: "基準日時点の価格. cashは1、その他は基準日時点の終値"
        tests:
          - not_null
          - dbt_utils.expression_is_true:
              expression: ">= 0"
      - name: current_value
        description: "時価評価額. cashは現金、その他は保有数量×基準日時点の終値"
        tests:
          - not_null
          - dbt_utils.expression_is_true:
              expression: ">= 0"
      - name: partition_date
        description: "基準日（パーティション用）"
        tests:
          - not_null

  - name: dm_daily_position_value
    description: "DM層。含み益を日次で集計したテーブル"
    columns:
      - name: account
        description: "口座名(gp_fund,yuitomaru..)"
        tests:
          - not_null
      - name: ticker
        description: "ticker名"
        tests:
          - not_null
      - name: asset_type
        description: "アセット種別(株,金利..)"
        tests:
          - not_null
      - name: asset_name
        description: "アセット名"
        tests:
          - not_null
      - name: position
        description: "保有数量"
        tests:
          - not_null
          - dbt_utils.expression_is_true:
              expression: ">= 0"
      - name: avg_buy_price
        description: "平均取得価格"
        tests:
          - not_null
          - dbt_utils.expression_is_true:
              expression: ">= 0"
      - name: close_price
        description: "基準日時点の終値"
        tests:
          - not_null
          - dbt_utils.expression_is_true:
              expression: ">= 0"
      - name: unrealized_value
        description: "基準日時点の含み益"
        tests:
          - not_null
      - name: unrealized_return_ratio
        description: "基準日時点の含み益率.実数なので、%とする場合は100倍すること"
        tests:
          - not_null
      - name: partition_date
        description: "基準日（パーティション用）"
        tests:
          - not_null

  - name: dm_daily_all_term_pl
    description: "DM層。全期間での通算PLを日次で集計したテーブル"
    columns:
      - name: account
        description: "口座名(gp_fund,yuitomaru..)"
        tests:
          - not_null
      - name: ticker
        description: "ticker名"
        tests:
          - not_null
      - name: asset_type
        description: "アセット種別(株,金利..)"
        tests:
          - not_null
      - name: asset_name
        description: "アセット名"
        tests:
          - not_null
      - name: total_buy_amount
        description: "全期間総購入金額"
        tests:
          - not_null
          - dbt_utils.expression_is_true:
              expression: ">= 0"
      - name: sell_amount_already
        description: "全期間における実現済みの売却金額"
        tests:
          - not_null
      - name: position_close_amount
        description: "基準日時点ポジション解消金額. 基準日時点の終値×保有数量"
        tests:
          - not_null
      - name: total_sell_amount
        description: "全期間における総売却額.含み益も含む"
        tests:
          - not_null
      - name: pl_amount_all_term
        description: "全期間における通算PL変化額. (実現済み売却金額 + 含み益) - 総購入金額"
        tests:
          - not_null
      - name: partition_date
        description: "基準日（パーティション用）"
        tests:
          - not_null

  - name: dm_daily_summary
    description: "DM層。各銘柄の価格変化とサマリー情報を日次で集計したテーブル"
    columns:
      - name: ticker
        description: "銘柄コード（例：^GSPC, BTC-USD）"
        tests:
          - not_null
      - name: order_group
        description: "表示グループ番号（1:株価指数, 2:債券, 3:為替, 4:暗号資産, 5:個別株）"
        tests:
          - not_null
      - name: order_index
        description: "グループ内の表示順序"
      - name: asset_name
        description: "アセット名"
        tests:
          - not_null
      - name: is_active_weekend
        description: "休日でも取引が行われるかどうか（TRUE:休日も取引, FALSE:平日のみ）"
        tests:
          - not_null
      - name: base_date
        description: "基準日（パーティション用）"
        tests:
          - not_null
      - name: recent_date
        description: "直近の取引日"
        tests:
          - not_null
      - name: prev_date
        description: "前営業日"
        tests:
          - not_null
      - name: date_7day_ago
        description: "7日前の営業日"
        tests:
          - not_null
      - name: date_28day_ago
        description: "28日前の営業日"
        tests:
          - not_null
      - name: price_recent_date
        description: "直近取引日の終値"
      - name: price_prev_date
        description: "前営業日の終値"
      - name: price_7day_ago
        description: "7日前営業日の終値"
      - name: price_28day_ago
        description: "28日前営業日の終値"
      - name: diff_recent_prev
        description: "直近価格と前営業日価格の差分"
      - name: diff_recent_7day
        description: "直近価格と7日前価格の差分"
      - name: diff_recent_28day
        description: "直近価格と28日前価格の差分"
      - name: rate_recent_prev
        description: "直近価格の前営業日からの変化率（実数なので、%とする場合は100倍すること）"
      - name: rate_recent_7day
        description: "直近価格の7日前からの変化率（実数なので、%とする場合は100倍すること）"
      - name: rate_recent_28day
        description: "直近価格の28日前からの変化率（実数なので、%とする場合は100倍すること）"

  - name: dm_max_price_monitor
    description: "DM層。一定期間内の最高値との差分を日次で集計したテーブル"
    columns:
      - name: order_group
        description: "表示グループ番号（1:株価指数, 2:債券, 3:為替, 4:暗号資産, 5:個別株）"
      - name: order_index
        description: "グループ内の表示順序"
      - name: ticker
        description: "銘柄コード（例：^GSPC, BTC-USD）"
      - name: asset_name
        description: "アセット名"
      - name: recent_price_date
        description: "直近価格日"
      - name: recent_price
        description: "直近価格"
      - name: max_price_3month
        description: "3カ月以内の最高値"
      - name: max_price_date_3month
        description: "3カ月以内の最高値の日付"
      - name: max_price_6month
        description: "6カ月以内の最高値"
      - name: max_price_date_6month
        description: "6カ月以内の最高値の日付"
      - name: max_price_1year
        description: "1年以内の最高値"
      - name: max_price_date_1year
        description: "1年以内の最高値の日付"
      - name: base_date
        description: "基準日（パーティション用）"

  - name: dm_watch_entry_point
    description: "DM層。ウォッチしている銘柄のエントリー水準と直近価格を日次で集計したテーブル"
    columns:
      - name: is_reached_entry_price
        description: "直近価格がエントリー水準に到達しているかどうか（TRUE:到達, FALSE:未到達）"
      - name: ticker
        description: "ticker名"
        tests:
          - not_null
      - name: asset_name
        description: "アセット名"
      - name: add_date
        description: "エントリー水準登録日"
        tests:
          - not_null
      - name: entry_price
        description: "エントリー水準価格"
        tests:
          - not_null
      - name: memo
        description: "メモ"
      - name: recent_price_date
        description: "直近価格日"
      - name: recent_price
        description: "直近価格"
        tests:
          - not_null
      - name: base_date
        description: "基準日（パーティション用）"
